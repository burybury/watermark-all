#!/bin/bash

WATERMARK="$1"
WATERMARK_SIZE="$(identify -format %w $WATERMARK)"
WATERMARK_SIZE=$((80 * $WATERMARK_SIZE / 100));
shift


# Iterate over all parameters except first one
while (( "$#" )); do

    FILE="$1"

    OUTPUT_FILE=${FILE#"."}
    OUTPUT_FILE="zresult$OUTPUT_FILE"
    OUTPUT_DIR=$(dirname $OUTPUT_FILE)

    PDF_WIDTH="1200"

    # Create the directory of the result watermarked image
    mkdir -p $OUTPUT_DIR

    echo "Watermarking $FILE...";

    # Watermark the pdf and create a new one
    # convert \
    #     -density 400 \
    #     $FILE null: $WATERMARK \
    #     -gravity Center \
    #     -sharpen 0x1.0 \
    #     -quality 100 \
    #     -compose multiply \
    #     -resize $PDF_WIDTH \
    #     -layers composite \
    #     $OUTPUT_FILE &&

    composite \
        -quality 100 \
        -gravity Center \
        -density 400 \
        -dissolve 80% \
        -sharpen 0x1.0 \
        -compose multiply \
        $WATERMARK \
        -resize $PDF_WIDTH \
        $FILE $OUTPUT_FILE &&


    echo "Joining to png $FILE.png..." &&

    # Join all pages in the pdf into a png
    pdfjoiner \
        $OUTPUT_FILE \
        $OUTPUT_FILE.png;

    shift
done
